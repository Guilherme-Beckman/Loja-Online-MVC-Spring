package com.beckman.lojaonline.services;

import static org.assertj.core.api.Assertions.assertThat;
import static org.mockito.Mockito.when;

import java.util.LinkedList;
import java.util.List;
import java.util.Optional;

import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.mockito.Mock;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest;
import org.springframework.test.context.ActiveProfiles;

import com.beckman.lojaonline.domain.cart.Cart;
import com.beckman.lojaonline.domain.cart.exceptions.CartNotFoundException;
import com.beckman.lojaonline.domain.cart.exceptions.IdNotValidException;
import com.beckman.lojaonline.domain.cartitem.CartItem;
import com.beckman.lojaonline.domain.product.Product;
import com.beckman.lojaonline.domain.product.exceptions.ProductNotFoundException;
import com.beckman.lojaonline.repositories.CartItemRepository;
import com.beckman.lojaonline.repositories.CartRepository;
import com.beckman.lojaonline.repositories.ProductRepository;

import jakarta.persistence.EntityNotFoundException;
import jakarta.transaction.Transactional;
@DataJpaTest
@ActiveProfiles("test")
class CartServiceTest {
	@Mock
	CartRepository repository;
	@Autowired
CartItemRepository itemRepository;
	@Mock
	ProductRepository productRepository;
//Adicionar produtos no carrinho * 
//Modificar quantidade de itens * 
//Deletar itens do carrinho
//Pegar todos os produtos do carrinho

	@Test
	@DisplayName("Should insert a item in a cart")
	void testAddItenToCart() {
		
		Cart newCart = new Cart();
		Product productTest = new Product( "ProductTest", 122, "A cool product");
		productTest.setId(1L);
		when(productRepository.findById(1L)).thenReturn(Optional.of(productTest));
		when(repository.findById((1L))).thenReturn(Optional.of(newCart));
		this.addItenOnCart(1L, 1L);
		Optional<CartItem> addedItem = this.itemRepository.findById(1L);
		Optional<Cart> postCart = this.repository.findById(1L);
		boolean isItemPresent = postCart.get().getItens().stream()
		        .anyMatch(itens ->
		                itens.getId().equals(addedItem.get().getId()) &&
		                        itens.getName().equals(addedItem.get().getName()) &&
		                        itens.getPrice().equals(addedItem.get().getPrice()) &&
		                        itens.getDescription().equals(addedItem.get().getDescription())
		        );
		assertThat(isItemPresent).isTrue();
		
		
	}
	@Test
	@DisplayName("Should increment a quantity of a iten in a cart")
	void testIncrementQuantity() {
		
		Cart newCart = new Cart();
		Product productTest = new Product( "ProductTest", 122, "A cool product");
		productTest.setId(1L);
		when(productRepository.findById(1L)).thenReturn(Optional.of(productTest));
		when(repository.findById((1L))).thenReturn(Optional.of(newCart));
		this.addItenOnCart(1L, 1L);
		Optional<CartItem> addedItem = this.itemRepository.findById(1L);
		assertThat(addedItem).isPresent();
		
		this.addItenOnCart(1L, 1L);
		Optional<CartItem> addedItem1 = this.itemRepository.findById(1L);
		assertThat(addedItem1.get().getQuantity()).isEqualTo(2);
	
		this.addItenOnCart(1L, 1L);
		Optional<CartItem> addedItem2 = this.itemRepository.findById(1L);
		assertThat(addedItem2.get().getQuantity()).isEqualTo(3);
	   
	}
	@Test
	@DisplayName("Should delete an iten from a cart")
	void testDeleteItenCart() {
		
		Cart newCart = new Cart();
		Product productTest = new Product( "ProductTest", 122, "A cool product");
		productTest.setId(1L);
		when(productRepository.findById(1L)).thenReturn(Optional.of(productTest));
		when(repository.findById((1L))).thenReturn(Optional.of(newCart));
		this.addItenOnCart(1L, 1L);
		Optional<CartItem> addedItem = this.itemRepository.findById(1L);
		assertThat(addedItem).isPresent();
		
		this.deleteProductInCart(1L, 1L);
		Optional<CartItem> deletedItem= this.itemRepository.findById(1L);
		assertThat(deletedItem.isPresent()).isFalse();		
		
	}
	
	
//---------------------------------------Services--------------------------------------//
	@Transactional
	public CartItem addItenOnCart (Long cartId, Long productId) {
		if (cartId !=null && cartId != 0 && productId !=null && productId != 0) {
		var cartItem = this.itemRepository.findById(productId);
		if(cartItem.isPresent() != true) {
		Cart cart = repository.findById(cartId).orElseThrow(CartNotFoundException::new);
		Product product = productRepository.findById(productId).orElseThrow(ProductNotFoundException::new);
		CartItem item = new CartItem();
		item.setCart(cart);
		item.setId(productId);
		item.setName(product.getName());
		item.setPrice(product.getPrice());
		item.setDescription(product.getDescription());
		item.setRating(product.getRating());
		item.setQuantity(1);
		if(cart.getItens().isEmpty()) {
		List<CartItem> itens = new LinkedList<>();
		itens.add(item);
		cart.setItens(itens);
		this.repository.save(cart);
		this.itemRepository.save(item);
		return item;
		}else {
			cart.getItens().add(item);
			this.repository.save(cart);
			this.itemRepository.save(item);
			return item;
			}
		}else {
			cartItem.get().setQuantity(cartItem.get().getQuantity()+1);
			return cartItem.get();
		}
		}else throw new IdNotValidException();
	}
	@Transactional
	public Cart deleteProductInCart(Long id, Long productId){
		if (id !=null && id != 0 && productId !=null && productId != 0) {
			Cart cart = this.repository.findById(id).orElseThrow(CartNotFoundException::new);
			CartItem product = this.itemRepository.findById(productId).orElseThrow(ProductNotFoundException::new);
			List<CartItem> allProducts = cart.getItens();
		       if (allProducts.contains(product)) {
		            allProducts.remove(product);
		            cart.setItens(allProducts);
		            repository.save(cart);
		            return cart;
		        } else {
		            throw new EntityNotFoundException("Product is not on the list");
		        }
		       }else {
			throw new IdNotValidException();
		}

}
}